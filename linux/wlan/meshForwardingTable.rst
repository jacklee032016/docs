Mesh节点转发表的功能
############################
李志杰 2006.09.22

.. contents::
   :depth: 4
   :local:


MESH网内跨层的路由
==========================
现有802.11s的WLAN MESH中的地址操作是基于二层的MAC地址，WLAN MESH的路由协议也是以MAC地址的形式操作的。

但是在一个实际的网络中，MESH网以外的节点是IP地址进行寻址，并进入MESH网的，因此在MESH网的网关节点（Portal节点和MAP）中，需要建立三层的路由转发表，也即在二层中需要建立并查找三层的路由表，即跨层设计。

但是在其他的只负责传输的节点中，则可以只存在二层的转发表。


一般的流程
=================
一个station访问另外一个station或Internet上主机的过程如下：

**入口节点（MAP/Portal节点）**
-------------------------------------
以目的IP地址查找IP地址和出口节点MAC地址的路由表；

找不到就开始MESH的路由请求过程，直到得到目的IP对应的出口节点的MAC（是MESH网关节点的MAC）
找到IP地址对应的MAC地址，就把帧的第三个MAC地址修改为该目的IP地址对应的MAC地址（这个MAC地址一般是MESH网关的出口节点的地址）

不能使用四地址格式，因为STATION节点发来的报文肯定是三地址格式的，使用四地址格式虽然可以保证比较好的兼容性，但是在入口节点和出口节点需要重新组织报文；使用三地址格式可以最大限度地减少报文的重新拷贝过程。

使用三地址格式时，始终用目的MAC取代BSSID字段，而在出口节点中，在更加目的节点的类型，恢复或改变ESSID，这样不再拷贝数据，只需要赋给MAC地址。


**基本的2.5层转发表结构**
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^


==========  ================  ==============
 目的IP       出口节点MAC       下一跳MAC
==========  ================  ==============
    IP            MAC             MAC                       
==========  ================  ==============




**转发节点**
-------------------------------------
* 转发节点之间传输的是TODS和FromDS均为0的WLAN帧
* 也即转发节点之间一定使用Ad Hoc模式组网
* 只使用帧的第三个MAC地址查找纯二层的转发表，没有三层的转发表
* 转发表上取出下一跳节点的MAC地址作为WLAN帧的DA地址（第一个地址），转发WLAN帧
* 如果此转发节点也是网关节点，首先检查第三个地址是否是本接口的地址，如果是则传递到虚拟的MESH_DEVICE，进入第三层，出MESH网（可以是AP节点：发给station；也可以是Portal节点：进入有线网）
* AP节点给station，需要修改第三个地址


**中间节点的转发表**
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^


==========  =================
 目的MAC        下一跳MAC
==========  =================
    MAC           MAC                        
==========  =================
